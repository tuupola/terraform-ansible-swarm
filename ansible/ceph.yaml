---
- hosts: all
  become: true

  name: Install CEPH
  tasks:
    - name: Add CEPH $basearch repository
      ansible.builtin.yum_repository:
        name: ceph
        description: Ceph $basearch
        baseurl: https://download.ceph.com/rpm-quincy/el8/$basearch
        file: ceph
        gpgkey: https://download.ceph.com/keys/release.asc
        gpgcheck: true
        enabled: true

    - name: Add CEPH noarch repository
      ansible.builtin.yum_repository:
        name: ceph-noarch
        description: Ceph noarch
        baseurl: https://download.ceph.com/rpm-quincy/el8/noarch
        file: ceph
        gpgkey: https://download.ceph.com/keys/release.asc
        gpgcheck: true
        enabled: true

    - name: Add CEPH source repository
      ansible.builtin.yum_repository:
        name: ceph-source
        description: Ceph SRPMS
        baseurl: https://download.ceph.com/rpm-quincy/el8/SRPMS
        file: ceph
        gpgkey: https://download.ceph.com/keys/release.asc
        gpgcheck: true
        enabled: true

    - name: Add EPEL repository
      ansible.builtin.dnf:
        name:
          - epel-release
        state: present

    - name: Install cephadm and ceph-common
      ansible.builtin.dnf:
        name:
          - cephadm
          - ceph-common
        state: present

    - name: Disable ceph traffic in default zone
      ansible.posix.firewalld:
        service: ceph
        permanent: true
        state: disabled
        immediate: true

    - name: Disable ceph-mon traffic in default zone
      ansible.posix.firewalld:
        service: ceph-mon
        permanent: true
        state: disabled
        immediate: true

    - name: Disable 9283/tcp traffic in default zone
      ansible.posix.firewalld:
        port: 9283/tcp
        permanent: true
        state: disabled
        immediate: true

    - name: Check for /etc/ceph/ceph.conf
      stat:
        path: /etc/ceph/ceph.conf
      register: ceph_conf

    - name: Bootstap CEPH cluster
      ansible.builtin.shell: cephadm bootstrap --mon-ip 10.0.0.1 --ssh-user ansible --skip-dashboard --skip-monitoring-stack --skip-firewalld
      delegate_to: manager-01
      run_once: true
      when: not ceph_conf.stat.exists

    - name: Get ceph.pub contents
      ansible.builtin.shell: cat /etc/ceph/ceph.pub
      register: ceph_pub
      delegate_to: manager-01
      run_once: true

    - name: Distribute ceph.pub to hosts
      ansible.builtin.lineinfile:
        path: /home/ansible/.ssh/authorized_keys
        line: "{{ ceph_pub.stdout }}"

    - name: Add manager-02 to the cluster
      shell: ceph orch host add manager-02 10.0.0.2 --labels _admin
      delegate_to: manager-01
      run_once: true

    - name: Add manager-03 to the cluster
      shell: ceph orch host add manager-03 10.0.0.3 --labels _admin
      delegate_to: manager-01
      run_once: true

    - name: Add all available disks to the cluster
      shell: ceph orch apply osd --all-available-devices
      delegate_to: manager-01
      run_once: true

    - name: Create volume named "shared"
      shell: ceph fs volume create shared
      delegate_to: manager-01
      run_once: true

    - name: Create a "/mnt/shared" directory if it does not exist
      ansible.builtin.file:
        path: /mnt/shared
        state: directory
        mode: '0755'

    - name: Wait for CEPH "shared" volume to become available
      ansible.builtin.wait_for:
        timeout: 30

    - name: Mount the CEPH "shared" volume
      ansible.posix.mount:
        src: admin@.shared=/
        path: /mnt/shared
        opts: mon_addr=10.0.0.1:6789,noatime,_netdev
        state: mounted
        fstype: ceph


        # register: result
        # until: result.rc == 0
        # retries: 6
        # delay: 10
